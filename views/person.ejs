<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="/global.css" />
    <title><%=Object.values(precachedaccount)[0].name%> on MOVR.</title>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="movr.eu-gb.mybluemix.net"/>
    <meta property="og:title" content="<%=Object.values(precachedaccount)[0].name%> on MOVR."/>
    <meta property="og:description" content="MOVR is an accountless way to connect accounts."/>
    <meta property="og:image" itemprop="image"  content="<%=Object.values(precachedaccount)[0].picture%>"/>
    <meta property="og:image:secure_url" itemprop="image" content="<%=Object.values(precachedaccount)[0].picture%>">
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="<%=url%><%=from%>/<%=name%>"/>
    <link rel="icon" href="/favicon.png">
</head>

<body>
    <div id="personbody">
        <div id="accountparent">
            <div id="accounts"></div>
        </div>
    </div>
    <script src="/progbg.js"></script>
    <script>
        const from = `<%-from%>`;
        const name = `<%-name%>`;
        const userid = `<%-sessionuserid%>`;
        const ids = <%-JSON.stringify(ids)%> ;
        const predata = <%-JSON.stringify(precachedaccount)%>;
        const logos = {
            "GITHUB_ID": `<svg class="logo" alt="GitHub Logo" align="left" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>`,
            "DISCORD_ID": `<svg class="logo" alt="Discord Logo" align="left" viewBox="0 0 245 240" aria-hidden="true"><path d="M104.4 103.9c-5.7 0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7 0 10.2-5 10.2-11.1.1-6.1-4.5-11.1-10.2-11.1zM140.9 103.9c-5.7 0-10.2 5-10.2 11.1s4.6 11.1 10.2 11.1c5.7 0 10.2-5 10.2-11.1s-4.5-11.1-10.2-11.1z"/><path d="M189.5 20h-134C44.2 20 35 29.2 35 40.6v135.2c0 11.4 9.2 20.6 20.5 20.6h113.4l-5.3-18.5 12.8 11.9 12.1 11.2 21.5 19V40.6c0-11.4-9.2-20.6-20.5-20.6zm-38.6 130.6s-3.6-4.3-6.6-8.1c13.1-3.7 18.1-11.9 18.1-11.9-4.1 2.7-8 4.6-11.5 5.9-5 2.1-9.8 3.5-14.5 4.3-9.6 1.8-18.4 1.3-25.9-.1-5.7-1.1-10.6-2.7-14.7-4.3-2.3-.9-4.8-2-7.3-3.4-.3-.2-.6-.3-.9-.5-.2-.1-.3-.2-.4-.3-1.8-1-2.8-1.7-2.8-1.7s4.8 8 17.5 11.8c-3 3.8-6.7 8.3-6.7 8.3-22.1-.7-30.5-15.2-30.5-15.2 0-32.2 14.4-58.3 14.4-58.3 14.4-10.8 28.1-10.5 28.1-10.5l1 1.2c-18 5.2-26.3 13.1-26.3 13.1s2.2-1.2 5.9-2.9c10.7-4.7 19.2-6 22.7-6.3.6-.1 1.1-.2 1.7-.2 6.1-.8 13-1 20.2-.2 9.5 1.1 19.7 3.9 30.1 9.6 0 0-7.9-7.5-24.9-12.7l1.4-1.6s13.7-.3 28.1 10.5c0 0 14.4 26.1 14.4 58.3 0 0-8.5 14.5-30.6 15.2z"/></svg>`,
            "TWITCH_ID": `<svg class="logo" alt="Twitch Logo" align="left" viewBox="0 0 2400 2800" aria-hidden="true"><path d="M500,0L0,500v1800h600v500l500-500h400l900-900V0H500z M2200,1300l-400,400h-400l-350,350v-350H600V200h1600V1300z"/><rect x="1700" y="550" width="200" height="600"/><rect x="1150" y="550" width="200" height="600"/></svg>`,
            "TWITTER_ID": `<svg class="logo" alt="Lwitter Logo" align="left" viewBox="0 0 248 204" aria-hidden="true"><g><path d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04   C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66   c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64   c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76   c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26   c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"/></g></svg>`
        };

        function addMeta(name, content) {
            let meta = document.createElement("meta");
            meta.name = name;
            meta.content = content;
            document.head.appendChild(meta)
        }

        function getUsername(accounttype, accountid) {
            return new Promise((resolve, reject) => {
                if (accountid == null)
                    return resolve({
                        name: "Add!",
                        isaddbutton: true
                    });
                if (accounttype in predata)
                    return resolve(predata[accounttype]);
                switch (accounttype) {
                    case "GITHUB_ID":
                        fetch("https://api.github.com/user/" + accountid).then(a => a.json())
                            .then(resolve)
                            .catch(reject);
                        break;
                    case "DISCORD_ID":
                        fetch("/getdiscordname/" + accountid).then(a => a.text()).then(
                                username => resolve({
                                    name: username
                                }))
                            .catch(reject);
                        break;
                    case "TWITCH_ID":
                        fetch("/api/gettwitchname/" + accountid).then(a => a.text()).then(
                                username => resolve({
                                    name: username,
                                    html_url: "https://twitch.tv/" + username
                                }))
                            .catch(reject);
                        break;
                    case "TWITTER_ID":
                        fetch("/api/gettwittername/" + accountid).then(a => a.json()).then(data => {
                            console.log(ids, ids[accounttype], accountid)
                            data.html_url = "https://twitter.com/" + data.screen_name;
                            resolve(data)
                        }).catch(
                            reject);
                    default:
                        break;
                }
            });
        }

        for (let account in ids) {
            //   Is account linked            Are we authenticated (Add buttons)    Is it the MOVR field
            if ((ids[account] != null || "<%=sessionuserid%>" === ids.ID.toString()) && account != "ID") {
                let div = document.createElement("div");
                let table = document.createElement("table");
                let tbody = document.createElement("tbody");
                table.appendChild(tbody);
                let tr1 = document.createElement("tr");
                let tr2 = document.createElement("tr");
                let tdlogo = document.createElement("td");
                let logo = document.createElement("svg");
                tdlogo.appendChild(logo);
                logo.outerHTML = logos[account];
                tdlogo.rowSpan = 2;
                tr1.appendChild(tdlogo);
                let acctype = document.createElement("td");
                acctype.classList = "smallcaps";
                acctype.innerText = account.slice(0, -3);
                tr1.appendChild(acctype);
                let accname = document.createElement("td");
                accname.innerText = "Loading..."
                getUsername(account, ids[account]).then(username => {
                    console.log(username);
                    accname.innerText = username.name;
                    if (username.html_url)
                        div.onclick = () => open(username.html_url);
                    if (username.isaddbutton)
                        div.onclick = event => {
                            switch (account) {
                                case "GITHUB_ID":
                                    location =
                                        "https://github.com/login/oauth/authorize?scope=user:email&client_id=<%= ghid %>&redirect_uri=<%=githubredirect%>/add";
                                    break;
                                case "DISCORD_ID":
                                    location =
                                        `https://discord.com/api/oauth2/authorize?client_id=<%= discordid %>&redirect_uri=<%= discordredirectadd %>&response_type=code&scope=identify&prompt=consent`;
                                    break;
                                case "TWITCH_ID":
                                    location =
                                        `https://id.twitch.tv/oauth2/authorize?response_type=code&client_id=<%=twitchid%>&redirect_uri=<%=twitchredirect%>/add&scope=user:read:email`;
                                    break;
                                case "TWITTER_ID":
                                    location =
                                        `/twitterauth/add`;
                                    break;
                                default:
                                    break;
                            }
                        };
                });
                tr2.appendChild(accname);
                tbody.appendChild(tr1);
                tbody.appendChild(tr2);
                div.appendChild(table);
                div.classList = "account";
                document.getElementById("accounts").appendChild(div);
            }
        }
    </script>

</body>

</html>